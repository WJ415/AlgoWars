//@version=6
// =============================
// AlgoWars 固定框架（不要改动除“用户策略区”之外的任何代码）
// =============================
strategy("模板-均线策略", 
     overlay=false,           // 固定：副图
     pyramiding=0,            // 固定：禁止同向加仓
     initial_capital=100000,  // 固定：初始资金 100k USD
     currency=currency.USD,   // 固定：USD 计价
     slippage=1,              // 固定：1 tick 滑点
     process_orders_on_close=true)  // 固定：收盘撮合；不要改

// —— 固定：统一用 UTC 起始时间（限制“入场”的开始时点）——
startT = timestamp(2000, 1, 1, 0, 0)
endT = timestamp(2025, 11, 1, 0, 0)
inRange = time >= startT and time <= endT  // 注意：time 为 UTC 毫秒时间戳



// =====================================================
// =============== 用户策略区（只改这里） ===============

// 策略名称：双均线交叉策略（Simple Moving Average Crossover）
// 策略逻辑简介：
//     该策略基于两条不同周期的简单移动平均线（SMA）进行趋势判断。
//     当短期均线（fast SMA）上穿长期均线（slow SMA）时，认为市场转为多头，触发做多信号；
//     当短期均线下穿长期均线时，认为市场转为空头，触发做空信号。
//     同时，为防止极端行情造成损失，策略设置了动态止盈止损比例，
//     在每次开仓后根据当前价格自动调整止盈价与止损价。

// —— 参数（与原策略一致）——
fastLen = input.int(20, 'Fast SMA')
slowLen = input.int(50, 'Slow SMA')
tpPct   = input.float(2.0, 'TP %') / 100.0
slPct   = input.float(1.0, 'SL %') / 100.0

// —— 指标计算 —— 
fast = ta.sma(close, fastLen)
slow = ta.sma(close, slowLen)


// —— 入场信号（沿用你的框架风格：inRange + barstate.isconfirmed）——
longEnter  = inRange and barstate.isconfirmed and ta.crossover(fast, slow)
shortEnter = inRange and barstate.isconfirmed and ta.crossunder(fast, slow)

// —— 开仓逻辑（保持“先平反向，再进场”，ID 用"L"/"S"）——
if longEnter and strategy.position_size <= 0
    if strategy.position_size < 0
        strategy.close("S")
    strategy.entry("L", strategy.long)

if shortEnter and strategy.position_size >= 0
    if strategy.position_size > 0
        strategy.close("L")
    strategy.entry("S", strategy.short)

// —— 止盈/止损（与原策略一致：基于当前 close 动态更新）——
strategy.exit('L-ex', 'L', stop = close * (1 - slPct), limit = close * (1 + tpPct))
strategy.exit('S-ex', 'S', stop = close * (1 + slPct), limit = close * (1 - tpPct))

// ============= 用户策略区结束（以上可改） =============
// =====================================================



// —— 固定：可视化（总资产USD + 最大回撤USD），不要改 —— 
eq = inRange ? strategy.equity : na

var float peak  = na
var float maxDD = na

if inRange
    // 维护峰值与最大回撤（USD，≤0）
    peak  := na(peak) ? eq : math.max(peak, eq)
    currDD = eq - peak
    maxDD := na(maxDD) ? currDD : math.min(maxDD, currDD)
else
    peak  := na
    maxDD := na

plot(eq,       "Equity (USD)",        format=format.price, linewidth=2)
plot(maxDD,    "Max Drawdown (USD)",  format=format.price, linewidth=2)
hline(100000,  "Initial 100k",        linestyle=hline.style_dotted)
